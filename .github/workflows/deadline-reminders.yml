name: Deadline Reminders

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  send-reminders:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Calculate days until deadline
        id: calculate
        run: |
          DEADLINE="2026-01-25T23:00:00Z"
          DEADLINE_TIMESTAMP=$(date -d "$DEADLINE" +%s)
          CURRENT_TIMESTAMP=$(date +%s)
          SECONDS_LEFT=$((DEADLINE_TIMESTAMP - CURRENT_TIMESTAMP))
          DAYS_LEFT=$((SECONDS_LEFT / 86400))
          
          echo "deadline=$DEADLINE" >> $GITHUB_OUTPUT
          echo "days_left=$DAYS_LEFT" >> $GITHUB_OUTPUT
          echo "Days remaining: $DAYS_LEFT"
          
          if [ $DAYS_LEFT -eq 5 ]; then
            echo "send_5day_reminder=true" >> $GITHUB_OUTPUT
          fi
          
          if [ $DAYS_LEFT -eq 2 ]; then
            echo "send_2day_reminder=true" >> $GITHUB_OUTPUT
          fi
          
          if [ $DAYS_LEFT -eq 0 ]; then
            echo "send_final_reminder=true" >> $GITHUB_OUTPUT
          fi

      - name: Send 5-day reminder
        if: steps.calculate.outputs.send_5day_reminder == 'true'
        run: |
          EXISTING=$(gh issue list --search "5 Days Left" --state all --json number --jq '.[0].number')
          
          if [ -z "$EXISTING" ]; then
            cat > reminder.md << 'EOFREMINDER'
          ## â° Deadline Reminder
          
          Hi there! Just a friendly reminder about your coding test deadline.
          
          ### Timeline:
          - **Deadline**: January 25, 2026 at 11:00 PM UTC
          - **Time remaining**: 5 days
          - **That's**: 120 hours from now
          
          ### Your Current Status:
          Check your latest score in the [Actions tab](../../actions).
          
          ### What You Should Do:
          - Push your latest code and check your score
          - Aim for at least 30 points to pass
          - Focus on requirements scoring 0 points
          - Review MANUAL.md for instructions
          
          Good luck! ğŸš€
          EOFREMINDER
            
            gh issue create --title "â° Reminder: 5 Days Left!" --label "reminder" --body-file reminder.md
            rm reminder.md
            echo "âœ… Reminder sent!"
          else
            echo "â„¹ï¸ Reminder already sent"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Send 2-day reminder
        if: steps.calculate.outputs.send_2day_reminder == 'true'
        run: |
          EXISTING=$(gh issue list --search "2 Days Left" --state all --json number --jq '.[0].number')
          
          if [ -z "$EXISTING" ]; then
            cat > reminder.md << 'EOFREMINDER'
          ## ğŸš¨ Final Push Time!
          
          You have **2 days left** to complete your coding test.
          
          ### Deadline: January 25, 2026 at 11:00 PM UTC
          
          ### Quick Check:
          Go to [Actions tab](../../actions) and check your score.
          **Minimum to pass: 30 points**
          
          ### Priority Items:
          - Personal answers (100+ words)
          - FocusTimer component created
          - Tests exist
          - Countdown logic works
          - Audio alert implemented
          
          You've got this! ğŸ’ª
          EOFREMINDER
            
            gh issue create --title "ğŸš¨ URGENT: 2 Days Left!" --label "reminder,urgent" --body-file reminder.md
            rm reminder.md
            echo "âœ… Urgent reminder sent!"
          else
            echo "â„¹ï¸ Reminder already sent"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Send deadline day reminder
        if: steps.calculate.outputs.send_final_reminder == 'true'
        run: |
          EXISTING=$(gh issue list --search "Today is the Deadline" --state all --json number --jq '.[0].number')
          
          if [ -z "$EXISTING" ]; then
            cat > reminder.md << 'EOFREMINDER'
          ## ğŸ”´ Last Day to Submit!
          
          Today is your **final day** to complete the coding test.
          
          **Deadline: January 25, 2026 at 11:00 PM UTC**
          
          ### What to Do NOW:
          1. Push your latest code
          2. Check your score in [Actions](../../actions)
          3. If below 30 points, fix the biggest issues first
          
          Good luck! ğŸš€
          EOFREMINDER
            
            gh issue create --title "ğŸ”´ TODAY IS THE DEADLINE!" --label "reminder,urgent" --body-file reminder.md
            rm reminder.md
            echo "âœ… Final reminder sent!"
          else
            echo "â„¹ï¸ Reminder already sent"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
